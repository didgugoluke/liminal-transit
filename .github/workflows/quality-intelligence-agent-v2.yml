name: 🧠 Quality Intelligence Agent V2

on:
  workflow_dispatch:
    inputs:
      quality_task:
        description: "Quality Intelligence task type"
        required: true
        default: "predictive-bug-detection"
        type: choice
        options:
          - "predictive-bug-detection"
          - "semantic-code-review"
          - "quality-metrics-analysis"
          - "regression-prediction"
      target_pr:
        description: "PR number for quality analysis"
        required: false
        type: string
      ai_model:
        description: "AI model for quality intelligence"
        required: false
        default: "claude-4"
        type: choice
        options:
          - "claude-4"
          - "gpt-4"
          - "bedrock-claude"

jobs:
  quality-intelligence-v2:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read

    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔧 Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: |
          echo "🔧 Installing dependencies for AI Provider Service integration..."
          npm install --production
          echo "✅ Dependencies installed"

      - name: 🧠 Quality Intelligence V2 Analysis
        id: quality-analysis
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          QUALITY_TASK: ${{ github.event.inputs.quality_task }}
          AI_MODEL: ${{ github.event.inputs.ai_model }}
          TARGET_PR: ${{ github.event.inputs.target_pr }}
        run: |
          echo "🔍 Starting Quality Intelligence V2 Analysis..."
          echo "========================================"
          echo "🧠 Using Dual AI Architecture (GitHub Copilot + Claude 4)"
          echo "📋 Task: ${{ github.event.inputs.quality_task }}"
          echo "🤖 AI Model: ${{ github.event.inputs.ai_model }}"
          echo "🎯 Target PR: ${{ github.event.inputs.target_pr }}"
          echo ""
          
          # Run Quality Intelligence Agent with AI Provider Service integration
          node scripts/quality-intelligence-agent.cjs
          
          echo ""
          echo "✅ Quality Intelligence V2 Analysis completed"

      - name: 📊 Quality Intelligence Summary
        run: |
          echo "🧠 Quality Intelligence Agent V2 Complete"
          echo "========================================="
          echo "📋 Task: ${{ github.event.inputs.quality_task }}"
          echo "🤖 AI Model: ${{ github.event.inputs.ai_model }}"
          echo "🎯 Target PR: ${{ github.event.inputs.target_pr }}"
          echo "🔄 Analysis Status: ${{ steps.quality-analysis.outputs.analysis_complete }}"
          echo "⚠️ Risk Level: ${{ steps.quality-analysis.outputs.risk_level }}"
          echo "🧠 Model Used: ${{ steps.quality-analysis.outputs.model_used }}"
          echo "🔢 Tokens Used: ${{ steps.quality-analysis.outputs.tokens_used }}"
          echo "⏱️ Response Time: ${{ steps.quality-analysis.outputs.response_time }}ms"
          echo ""
          echo "✅ V2 Quality Intelligence with Claude 4 integration complete"
          echo "🚀 Advanced code analysis and predictive bug detection operational"