name: ğŸ” PR Monitor Agent - Simple

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to monitor"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-monitor:
    name: ğŸ” PR Monitor Execution
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Rate Limiting
        run: |
          echo "Setting up PR Monitor environment with rate limiting..."
          chmod +x scripts/github-rate-limit-manager.sh

          if ! scripts/github-rate-limit-manager.sh check; then
            echo "âŒ Rate limits too low for PR Monitor operations"
            scripts/github-rate-limit-manager.sh emergency "PR Monitor"
            exit 1
          fi

          echo "âœ… Rate limits OK - proceeding with monitoring"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Configure GitHub CLI
        run: |
          if ! gh auth status; then
            echo "âŒ GitHub CLI authentication failed"
            exit 1
          fi
          echo "âœ… GitHub CLI configured successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Check PR Status
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "âŒ No PR number provided"
            exit 1
          fi

          echo "ğŸ” Checking PR #$PR_NUMBER..."

          # Get basic PR info
          PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title')
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft --jq '.isDraft')
          AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')

          echo "ğŸ“‹ PR: #$PR_NUMBER - $PR_TITLE"
          echo "ğŸ‘¤ Author: $AUTHOR" 
          echo "ğŸ“ Draft: $IS_DRAFT"

          # Set environment variables
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "IS_DRAFT=$IS_DRAFT" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV

      - name: ğŸ¯ Process Draft PR
        if: env.IS_DRAFT == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          echo "ğŸ” Processing draft PR #$PR_NUMBER..."
          
          # Simple readiness check
          if echo "${{ env.AUTHOR }}" | grep -iq "copilot"; then
            echo "ğŸ¤– Copilot PR detected - marking as ready"
            gh pr ready "$PR_NUMBER"
            gh pr comment "$PR_NUMBER" --body "ğŸ¤– PR Monitor Agent - Auto-promoted to ready for review"
          else
            echo "ğŸ‘¤ Human PR - leaving as draft"
          fi

      - name: ğŸš¨ Emergency Cleanup
        if: failure()
        run: |
          echo "ğŸš¨ PR Monitor failed - performing cleanup..."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Monitor Completion
        run: |
          echo "ğŸ” PR Monitor Agent completed successfully"
          echo "ğŸ“Š Processed PR: #${{ env.PR_NUMBER }}"
