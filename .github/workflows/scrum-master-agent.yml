name: ğŸƒâ€â™‚ï¸ Scrum Master Agent - Story Lifecycle Management

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      story_number:
        description: "Story issue number to manage"
        required: true
        type: string
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - "start_story"
          - "check_progress"
          - "handoff_to_dev"
        default: "start_story"

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  scrum-master:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (contains(github.event.comment.body, 'scrum master agent') && 
       (contains(github.event.issue.labels.*.name, 'epic-story') || 
        contains(github.event.issue.labels.*.name, 'epic-task') ||
        contains(github.event.issue.labels.*.name, 'ai-agent')))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rate Limiting
        run: |
          echo "Setting up Scrum Master environment with rate limiting..."
          chmod +x scripts/github-rate-limit-manager.sh

          # Check initial rate limits
          if ! scripts/github-rate-limit-manager.sh check; then
            echo "âŒ Rate limits too low for Scrum Master operations"
            scripts/github-rate-limit-manager.sh emergency "Scrum Master Agent"
            exit 1
          fi

          echo "âœ… Rate limits OK - proceeding with sprint management"
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}

      - name: Sprint Management
        run: |
          echo "ğŸƒâ€â™‚ï¸ Scrum Master Agent Starting..."
          echo "Repository: ${{ github.repository }}"
          echo "Trigger: ${{ github.event_name }}"

          # Set story number and action based on trigger with proper defaults
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            STORY_NUMBER="${{ github.event.inputs.story_number || '54' }}"
            ACTION="${{ github.event.inputs.action || 'start_story' }}"
          else
            # Extract story number from issue or comment context
            STORY_NUMBER="${{ github.event.issue.number || '54' }}"
            ACTION="start_story"
          fi

          # Validate inputs before setting environment
          if [ -z "$STORY_NUMBER" ] || [ "$STORY_NUMBER" = "null" ]; then
            STORY_NUMBER="54"
          fi

          if [ -z "$ACTION" ] || [ "$ACTION" = "null" ]; then
            ACTION="start_story"
          fi

          echo "STORY_NUMBER=$STORY_NUMBER" >> $GITHUB_ENV
          echo "ACTION=$ACTION" >> $GITHUB_ENV
          echo "PROJECT_ID=PVT_kwHOCf5VHc4BB2AJ" >> $GITHUB_ENV
          echo "PROJECT_NUMBER=2" >> $GITHUB_ENV

          echo "Managing Story: #$STORY_NUMBER"
          echo "Action: $ACTION"

      - name: ğŸ“Š Analyze Story State
        id: analyze
        run: |
          echo "ğŸ” Analyzing Story #$STORY_NUMBER current state..."

          # Get story details
          STORY_DATA=$(gh issue view "$STORY_NUMBER" --json title,labels,state,body)
          STORY_TITLE=$(echo "$STORY_DATA" | jq -r '.title')
          STORY_STATE=$(echo "$STORY_DATA" | jq -r '.state')

          echo "story_title=$STORY_TITLE" >> $GITHUB_OUTPUT
          echo "story_state=$STORY_STATE" >> $GITHUB_OUTPUT

          # Get current project status
          PROJECT_ITEMS=$(gh project item-list "$PROJECT_NUMBER" --owner "@me" --format json)
          CURRENT_STATUS=$(echo "$PROJECT_ITEMS" | jq -r --arg title "$STORY_TITLE" '.items[] | select(.content.title == $title) | .status // "No Status"')

          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT

          # Check if story has associated tasks
          # Try multiple search patterns for different story types
          if [[ "$STORY_TITLE" =~ Story[[:space:]]+[0-9]+ ]]; then
            # Epic story pattern: "Epic.*Story X"
            STORY_PATTERN=$(echo "$STORY_TITLE" | grep -o 'Story [0-9]*')
            TASKS=$(gh issue list --search "Epic.*$STORY_PATTERN" --json number,title --label epic-task)
          else
            # Non-Epic story pattern: search for tasks that reference the story
            # For "Hello World E2E", search for tasks containing "Hello World"
            STORY_KEYWORDS=$(echo "$STORY_TITLE" | sed 's/E2E//' | sed 's/[[:space:]]*$//')
            TASKS=$(gh issue list --search "$STORY_KEYWORDS" --json number,title --label epic-task)
          fi

          TASK_COUNT=$(echo "$TASKS" | jq length)
          TASK_NUMBERS=$(echo "$TASKS" | jq -r '.[].number' | tr '\n' ',' | sed 's/,$//')

          echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
          echo "task_numbers=$TASK_NUMBERS" >> $GITHUB_OUTPUT

          echo "ğŸ“ˆ Story Analysis Complete:"
          echo "  Title: $STORY_TITLE"
          echo "  State: $STORY_STATE"
          echo "  Project Status: $CURRENT_STATUS"
          echo "  Associated Tasks: $TASK_COUNT ($TASK_NUMBERS)"
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}

      - name: ğŸš€ Execute Scrum Master Action
        id: execute
        run: |
          ACTION="${{ env.ACTION }}"
          STORY_NUMBER="${{ env.STORY_NUMBER }}"
          PROJECT_ID="${{ env.PROJECT_ID }}"
          CURRENT_STATUS="${{ steps.analyze.outputs.current_status }}"
          STORY_TITLE="${{ steps.analyze.outputs.story_title }}"
          TASK_COUNT="${{ steps.analyze.outputs.task_count }}"

          echo "ğŸ¯ Executing Action: $ACTION"
          echo "Current Status: $CURRENT_STATUS"

          case "$ACTION" in
            "start_story")
              echo "ğŸ Starting Story Lifecycle Management..."
              
              # First, ensure story is added to project
              echo "ğŸ“‹ Ensuring story is in project..."
              if ! gh project item-list "$PROJECT_ID" --owner "didgugoluke" --format json | jq -e --arg title "$STORY_TITLE" '.items[] | select(.content.title == $title)' > /dev/null; then
                echo "â• Adding story to project..."
                if gh project item-add "$PROJECT_NUMBER" --owner "didgugoluke" --url "https://github.com/didgugoluke/liminal-transit/issues/$STORY_NUMBER"; then
                  echo "âœ… Story added to project successfully"
                  sleep 2  # Brief pause for project system to sync
                else
                  echo "âŒ Failed to add story to project"
                  echo "action_result=project_add_failed" >> $GITHUB_OUTPUT
                  echo "next_action=retry_later" >> $GITHUB_OUTPUT
                  exit 0
                fi
              else
                echo "âœ… Story already in project"
              fi
              
              # Move from No Status to Todo (using correct status name)
              if [ "$CURRENT_STATUS" = "No Status" ] || [ "$CURRENT_STATUS" = "null" ] || [ -z "$CURRENT_STATUS" ]; then
                echo "ğŸ“‹ Moving story to Todo status..."
                
              # Get the item ID for this story
              ITEM_ID=$(gh project item-list "$PROJECT_NUMBER" --owner "didgugoluke" --format json | jq -r --arg title "$STORY_TITLE" '.items[] | select(.content.title == $title) | .id')                if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
                  echo "Found item ID: $ITEM_ID"
                  if gh project item-edit --id "$ITEM_ID" --field-id "PVTSSF_lAHOCf5VHc4BB2AJzg0OtoQ" --single-select-option-id "f75ad846" --project-id "$PROJECT_ID"; then
                    echo "âœ… Status updated successfully"
                    
                    # Add story management comment with rate limiting
                    if scripts/github-rate-limit-manager.sh check-rest "story comment" 10; then
                      gh issue comment "$STORY_NUMBER" --body "ğŸƒâ€â™‚ï¸ Scrum Master Agent - Story Activated. Moved to Todo status. $TASK_COUNT tasks identified. Ready for Development Agent handoff."
                    else
                      echo "âš ï¸ Skipping comment due to rate limits"
                    fi
                  else
                    echo "âŒ Failed to update story status to Todo"
                    echo "action_result=status_update_failed" >> $GITHUB_OUTPUT
                  fi
                else
                  echo "âŒ Could not find item ID for story: $STORY_TITLE"
                  echo "action_result=item_not_found" >> $GITHUB_OUTPUT
                fi
                
                # Set success action if we got this far
                if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
                  echo "action_result=moved_to_todo" >> $GITHUB_OUTPUT
                  echo "next_action=handoff_to_dev" >> $GITHUB_OUTPUT
                fi
              else
                echo "âš ï¸  Story is already in progress (Status: $CURRENT_STATUS)"
                echo "action_result=already_in_progress" >> $GITHUB_OUTPUT
                echo "next_action=check_progress" >> $GITHUB_OUTPUT
              fi
              ;;
              
            "handoff_to_dev")
              echo "ğŸ”„ Handing off to Development Agent..."
              
              # Trigger Development Agent workflow (using GITHUB_TOKEN for workflow triggers)
              GH_TOKEN="${{ secrets.GITHUB_TOKEN }}" gh workflow run development-agent.yml \
                -f story_number="$STORY_NUMBER" \
                -f action="take_story" || echo "Development Agent workflow trigger may have failed"
              
              gh issue comment "$STORY_NUMBER" --body "ğŸ”„ Handoff to Development Agent. Story #$STORY_NUMBER transitioning from To Do to In Progress."
              
              echo "action_result=handed_off" >> $GITHUB_OUTPUT
              ;;
              
            "check_progress")
              echo "ğŸ“Š Checking story progress..."
              
              # Get updated status
              PROJECT_ITEMS=$(gh project item-list "$PROJECT_NUMBER" --owner "@me" --format json)
              UPDATED_STATUS=$(echo "$PROJECT_ITEMS" | jq -r --arg title "$STORY_TITLE" '.items[] | select(.content.title == $title) | .status // "No Status"')
              
              gh issue comment "$STORY_NUMBER" --body "ğŸ“Š Scrum Master Progress Check. Story #$STORY_NUMBER status: $UPDATED_STATUS. $TASK_COUNT tasks. Timestamp: $(date)"
              
              echo "action_result=progress_checked" >> $GITHUB_OUTPUT
              echo "updated_status=$UPDATED_STATUS" >> $GITHUB_OUTPUT
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ACTION: ${{ env.ACTION }}
          STORY_NUMBER: ${{ env.STORY_NUMBER }}
          PROJECT_ID: ${{ env.PROJECT_ID }}

      - name: ğŸ¯ Schedule Next Actions
        if: steps.execute.outputs.next_action
        env:
          STORY_NUMBER: ${{ env.STORY_NUMBER }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_ACTION="${{ steps.execute.outputs.next_action }}"

          echo "â° Scheduling next action: $NEXT_ACTION"

          if [ "$NEXT_ACTION" = "handoff_to_dev" ]; then
            echo "ğŸš€ Triggering Development Agent in 30 seconds..."
            sleep 30
            
            # Trigger Development Agent workflow (using GITHUB_TOKEN for workflow triggers)
            GH_TOKEN="${{ secrets.GITHUB_TOKEN }}" gh workflow run development-agent.yml \
              -f story_number="$STORY_NUMBER" \
              -f action="take_story" || echo "Development Agent workflow may need manual trigger"
          fi

      - name: ğŸ“‹ Generate Scrum Report
        env:
          STORY_NUMBER: ${{ env.STORY_NUMBER }}
          ACTION: ${{ env.ACTION }}
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ACTION_RESULT="${{ steps.execute.outputs.action_result }}"
          STORY_TITLE="${{ steps.analyze.outputs.story_title }}"
          CURRENT_STATUS="${{ steps.analyze.outputs.current_status }}"
          TASK_COUNT="${{ steps.analyze.outputs.task_count }}"

          echo "ğŸ“‹ Scrum Master Agent Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ• Timestamp: $(date)"
          echo "ğŸ¯ Story: #$STORY_NUMBER - $STORY_TITLE"
          echo "ğŸ”§ Action Executed: $ACTION"
          echo "ğŸ“Š Result: $ACTION_RESULT"
          echo "ğŸ“ˆ Current Status: $CURRENT_STATUS"
          echo "ğŸ“‹ Associated Tasks: $TASK_COUNT"
          echo ""
          echo "ğŸ¤– Scrum Master Agent Status: âœ… OPERATIONAL"
          echo "ğŸš€ Story Lifecycle: MANAGED"

      - name: ğŸ’¬ Update Test Case Issue
        if: env.STORY_NUMBER == '54'
        env:
          STORY_NUMBER: ${{ env.STORY_NUMBER }}
          ACTION: ${{ env.ACTION }}
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ACTION_RESULT="${{ steps.execute.outputs.action_result }}"

          gh issue comment 62 --body "ğŸƒâ€â™‚ï¸ Scrum Master Agent Update. Test Story #54. Action: $ACTION. Result: $ACTION_RESULT. Timestamp: $(date). End-to-end test progressing."

      - name: âœ… Scrum Master Completion
        run: |
          echo "ğŸƒâ€â™‚ï¸ Scrum Master Agent completed successfully"
          echo "ğŸ“Š Story lifecycle management active"
          echo "ğŸ”„ Agent coordination operational"
          echo "ğŸ¯ Issue #62 test case: Scrum Master phase complete âœ…"
