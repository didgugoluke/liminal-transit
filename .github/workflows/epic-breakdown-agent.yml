name: ðŸ“‹ Epic Breakdown Agent - Story & Task Generator

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  epic-breakdown:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'Epic breakdown agent') && contains(github.event.issue.labels.*.name, 'epic')
    
    steps:
      - name: ðŸ—ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“‹ Start Epic Breakdown
        run: |
          echo "Epic Breakdown Agent activated!"
          EPIC_NUMBER="${{ github.event.issue.number }}"
          EPIC_TITLE="${{ github.event.issue.title }}"
          
          gh issue comment ${{ github.event.issue.number }} --body "ðŸ“‹ **Epic Breakdown Agent Activated**
          
          **Epic**: $EPIC_TITLE (#$EPIC_NUMBER)
          **Status**: Starting strategic breakdown into Stories and Tasks
          **Action**: Creating GitHub Project hierarchy with Observatory tracking
          
          **Processing Epic breakdown...**"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ­ Create Epic 1 Stories
        id: create_stories
        run: |
          echo "Creating Story issues for Epic 1..."
          EPIC_NUMBER="${{ github.event.issue.number }}"
          
          # Story 1: Project Architecture & Foundation
          STORY_1=$(gh issue create \
            --title "Epic 1 Story 1: Project Architecture & Foundation" \
            --body "## ðŸŽ­ Epic Story Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Story ID**: 1
          **Story Name**: Project Architecture & Foundation
          
          ## ðŸ“‹ Story Overview
          
          Establish the foundational architecture and project structure for NOVELI.SH, including TypeScript setup, modern tooling configuration, and AI Native development patterns.
          
          ## ðŸŽ¯ Story Goals
          
          - TypeScript project structure with proper configuration
          - Modern build tooling (Vite/esbuild integration)  
          - AI Native development patterns and conventions
          - Foundation for scalable codebase architecture
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Prerequisite for all other Epic 1 stories
          
          ## ðŸ“Š Implementation Status
          
          - [ ] Tasks created and assigned to AI agents
          - [ ] GitHub Project integration complete
          - [ ] Observatory tracking configured
          
          Ready for Task breakdown and AI agent execution." \
            --label "ai-agent,epic-story,P1")
          
          STORY_1_ID=$(echo $STORY_1 | grep -o '[0-9]*$')
          
          # Story 2: Database Design & Models
          STORY_2=$(gh issue create \
            --title "Epic 1 Story 2: Database Design & Models" \
            --body "## ðŸŽ­ Epic Story Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Story ID**: 2  
          **Story Name**: Database Design & Models
          
          ## ðŸ“‹ Story Overview
          
          Design and implement database schema, models, and data access patterns for the core platform, supporting user management, content organization, and AI agent coordination.
          
          ## ðŸŽ¯ Story Goals
          
          - Database schema design for users, content, AI agents
          - TypeScript models and interfaces
          - Data access layer with proper abstractions
          - Migration and seeding infrastructure
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER  
          - Requires Story 1 (Project Architecture) completion
          
          ## ðŸ“Š Implementation Status
          
          - [ ] Tasks created and assigned to AI agents
          - [ ] GitHub Project integration complete
          - [ ] Observatory tracking configured
          
          Ready for Task breakdown and AI agent execution." \
            --label "ai-agent,epic-story,P1")
          
          STORY_2_ID=$(echo $STORY_2 | grep -o '[0-9]*$')
          
          # Story 3: API Design & Core Endpoints  
          STORY_3=$(gh issue create \
            --title "Epic 1 Story 3: API Design & Core Endpoints" \
            --body "## ðŸŽ­ Epic Story Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Story ID**: 3
          **Story Name**: API Design & Core Endpoints
          
          ## ðŸ“‹ Story Overview
          
          Design and implement RESTful API endpoints for the core platform functionality, including authentication, user management, and content operations with proper validation and error handling.
          
          ## ðŸŽ¯ Story Goals
          
          - RESTful API design following OpenAPI specifications
          - Core endpoints for authentication and user management
          - Request validation and error handling middleware
          - API documentation and testing infrastructure
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Requires Story 1 (Project Architecture) and Story 2 (Database Design)
          
          ## ðŸ“Š Implementation Status
          
          - [ ] Tasks created and assigned to AI agents  
          - [ ] GitHub Project integration complete
          - [ ] Observatory tracking configured
          
          Ready for Task breakdown and AI agent execution." \
            --label "ai-agent,epic-story,P1")
          
          STORY_3_ID=$(echo $STORY_3 | grep -o '[0-9]*$')
          
          echo "Created Stories: #$STORY_1_ID, #$STORY_2_ID, #$STORY_3_ID"
          echo "story_ids=$STORY_1_ID,$STORY_2_ID,$STORY_3_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âš¡ Create Tasks for Each Story
        id: create_tasks
        run: |
          echo "Creating Task issues for Epic 1 Stories..."
          EPIC_NUMBER="${{ github.event.issue.number }}"
          IFS=',' read -ra STORIES <<< "${{ steps.create_stories.outputs.story_ids }}"
          
          STORY_1_ID="${STORIES[0]}"
          STORY_2_ID="${STORIES[1]}"  
          STORY_3_ID="${STORIES[2]}"
          
          ALL_TASK_IDS=""
          
          # Tasks for Story 1: Project Architecture & Foundation
          TASK_1_1=$(gh issue create \
            --title "Epic 1 Story 1 Task 1: TypeScript Configuration & Project Structure" \
            --body "## âš¡ Epic Task Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Parent Story**: #$STORY_1_ID
          **Task ID**: 1.1
          **Task Description**: Set up TypeScript configuration and project structure
          
          ## ðŸ¤– AI Agent Assignment
          
          **Primary Agent**: CodeGen Agent
          **Supporting Agents**: Observatory Agent
          **Execution Mode**: Autonomous implementation
          
          ## âœ… Success Criteria
          
          - [ ] tsconfig.json configured with strict settings
          - [ ] Project directory structure established  
          - [ ] Package.json with TypeScript dependencies
          - [ ] Basic build scripts configured
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Parent Story: #$STORY_1_ID
          
          Ready for AI Agent autonomous execution." \
            --label "ai-agent,epic-task,P2")
          
          TASK_1_1_ID=$(echo $TASK_1_1 | grep -o '[0-9]*$')
          ALL_TASK_IDS="$ALL_TASK_IDS,$TASK_1_1_ID"
          
          TASK_1_2=$(gh issue create \
            --title "Epic 1 Story 1 Task 2: Modern Build Tooling Integration" \
            --body "## âš¡ Epic Task Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Parent Story**: #$STORY_1_ID
          **Task ID**: 1.2
          **Task Description**: Integrate modern build tooling (Vite/esbuild)
          
          ## ðŸ¤– AI Agent Assignment
          
          **Primary Agent**: CodeGen Agent
          **Supporting Agents**: Observatory Agent
          **Execution Mode**: Autonomous implementation
          
          ## âœ… Success Criteria
          
          - [ ] Vite configuration for TypeScript
          - [ ] Development server setup
          - [ ] Build optimization configured
          - [ ] Hot reload functionality working
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Parent Story: #$STORY_1_ID
          - Previous Task: #$TASK_1_1_ID
          
          Ready for AI Agent autonomous execution." \
            --label "ai-agent,epic-task,P2")
          
          TASK_1_2_ID=$(echo $TASK_1_2 | grep -o '[0-9]*$')
          ALL_TASK_IDS="$ALL_TASK_IDS,$TASK_1_2_ID"
          
          # Tasks for Story 2: Database Design & Models
          TASK_2_1=$(gh issue create \
            --title "Epic 1 Story 2 Task 1: Database Schema Design" \
            --body "## âš¡ Epic Task Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Parent Story**: #$STORY_2_ID
          **Task ID**: 2.1
          **Task Description**: Design database schema for core entities
          
          ## ðŸ¤– AI Agent Assignment
          
          **Primary Agent**: DataGov Agent
          **Supporting Agents**: CodeGen Agent, Observatory Agent
          **Execution Mode**: Autonomous implementation
          
          ## âœ… Success Criteria
          
          - [ ] User entity schema designed
          - [ ] Content entity relationships mapped
          - [ ] AI agent coordination schema planned
          - [ ] Migration scripts structure defined
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Parent Story: #$STORY_2_ID
          - Requires Story 1 completion
          
          Ready for AI Agent autonomous execution." \
            --label "ai-agent,epic-task,P2")
          
          TASK_2_1_ID=$(echo $TASK_2_1 | grep -o '[0-9]*$')
          ALL_TASK_IDS="$ALL_TASK_IDS,$TASK_2_1_ID"
          
          # Tasks for Story 3: API Design & Core Endpoints
          TASK_3_1=$(gh issue create \
            --title "Epic 1 Story 3 Task 1: API Specification Design" \
            --body "## âš¡ Epic Task Implementation
          
          **Parent Epic**: #$EPIC_NUMBER
          **Parent Story**: #$STORY_3_ID
          **Task ID**: 3.1
          **Task Description**: Design OpenAPI specification for core endpoints
          
          ## ðŸ¤– AI Agent Assignment
          
          **Primary Agent**: CodeGen Agent
          **Supporting Agents**: DataGov Agent, Observatory Agent
          **Execution Mode**: Autonomous implementation
          
          ## âœ… Success Criteria
          
          - [ ] OpenAPI 3.0 specification created
          - [ ] Authentication endpoints defined
          - [ ] User management endpoints specified
          - [ ] Content operation endpoints planned
          
          ## ðŸ”— Dependencies
          
          - Parent Epic: #$EPIC_NUMBER
          - Parent Story: #$STORY_3_ID
          - Requires Story 1 and Story 2 completion
          
          Ready for AI Agent autonomous execution." \
            --label "ai-agent,epic-task,P2")
          
          TASK_3_1_ID=$(echo $TASK_3_1 | grep -o '[0-9]*$')
          ALL_TASK_IDS="$ALL_TASK_IDS,$TASK_3_1_ID"
          
          # Remove leading comma
          ALL_TASK_IDS=$(echo $ALL_TASK_IDS | sed 's/^,//')
          echo "Created Tasks: $ALL_TASK_IDS"
          echo "task_ids=$ALL_TASK_IDS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”— Add Items to GitHub Project
        run: |
          echo "Adding Epic breakdown items to GitHub Project..."
          EPIC_NUMBER="${{ github.event.issue.number }}"
          STORY_IDS="${{ steps.create_stories.outputs.story_ids }}"
          TASK_IDS="${{ steps.create_tasks.outputs.task_ids }}"
          
          # Add Stories to project
          IFS=',' read -ra STORIES <<< "$STORY_IDS"
          for story_id in "${STORIES[@]}"; do
            if [ -n "$story_id" ]; then
              gh project item-add 1 --owner didgugoluke --url "https://github.com/didgugoluke/liminal-transit/issues/$story_id"
              echo "Added Story #$story_id to GitHub Project"
            fi
          done
          
          # Add Tasks to project  
          IFS=',' read -ra TASKS <<< "$TASK_IDS"
          for task_id in "${TASKS[@]}"; do
            if [ -n "$task_id" ]; then
              gh project item-add 1 --owner didgugoluke --url "https://github.com/didgugoluke/liminal-transit/issues/$task_id"
              echo "Added Task #$task_id to GitHub Project"
            fi
          done
          
          # Final status comment
          gh issue comment ${{ github.event.issue.number }} --body "âš¡ **Epic 1 Breakdown Complete**
          
          **Epic**: #$EPIC_NUMBER  
          **Stories Created**: $STORY_IDS
          **Tasks Created**: $TASK_IDS
          
          ## ðŸŽ¯ **Ready for AI Agent Execution**
          
          **GitHub Project**: All items added with proper hierarchy
          **Observatory**: Tracking configured for Epic progress
          **AI Agents**: Ready for autonomous task execution
          
          **Epic Structure**: Epic â†’ Stories â†’ Tasks
          **Project Board**: https://github.com/users/didgugoluke/projects/1
          
          Epic breakdown and orchestration complete! ðŸš€"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
